<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/common :: head('Edit Post')"></head>
<body>
<header th:replace="fragments/common :: nav"></header>

<main class="container">
    <!-- Banner -->
    <section class="cover">
        <div class="cover__title">Edit Post</div>
    </section>

    <!-- Bar -->
    <section class="community-bar card">
        <div class="bar-left">
            <div class="avatar lg">✏️</div>
            <div class="name">Edit your post</div>
        </div>
        <div class="bar-right">
            <a class="btn ghost" th:href="@{'/clubs/' + ${clubId} + '/posts/' + ${postId}}">View post</a>
            <a class="btn ghost" th:href="@{'/clubs/' + ${clubId}}">Back to club</a>
        </div>
    </section>

    <!-- Editor -->
    <article class="card editor mt-2">
        <!-- Edit form -->
        <form th:action="@{'/clubs/' + ${clubId} + '/posts/' + ${postId}}"
              method="post" enctype="multipart/form-data">
            <div class="editor-head">
                <h3 class="m-0">Post content</h3>
                <div id="charCounter" class="counter">0 / 10000</div>
            </div>

            <textarea name="content" required th:text="${content}"
                      placeholder="Write something meaningful for your community…"></textarea>

            <!-- Current image (if any) -->
            <div class="mt-1" th:if="${currentImageUrl != null}">
                <div class="image-preview">
                    <img th:src="${currentImageUrl}" alt="Current image">
                </div>
                <label class="mt-1">
                    <input type="checkbox" name="removeImage"> Remove current image
                </label>
            </div>

            <!-- Upload/replace -->
            <div class="h-stack mt-1">
                <label class="file">
                    <input type="file" name="image" accept="image/*">
                    <span>Upload new image</span>
                </label>
                <div class="help">Uploading a new image will replace the current one (unless “Remove” is checked). Max 5MB.</div>
            </div>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div class="editor-actions">
                <button class="btn" type="submit">Save changes</button>
                <a class="btn subtle" th:href="@{'/clubs/' + ${clubId} + '/posts/' + ${postId}}">Cancel</a>
            </div>
        </form>

        <!-- Delete form (separate, to avoid nested forms) -->
        <form th:if="${postId != null}"
              th:action="@{'/clubs/' + ${clubId} + '/posts/' + ${postId} + '/delete'}"
              method="post" class="inline mt-1" data-confirm="Delete this post?">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn subtle danger" type="submit">Delete</button>
        </form>
    </article>
</main>

<!-- Live character counter (page-scoped) -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      const ta = document.querySelector('textarea[name="content"]');
      const counter = document.getElementById('charCounter');
      const max = 10000;
      if (ta && counter) {
        const update = () => {
          const n = ta.value.length;
          counter.textContent = n + ' / ' + max;
          counter.classList.toggle('warn', n > max - 200);
        };
        ta.addEventListener('input', update);
        update();
      }
    });
</script>
</body>
</html>