<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/common :: head('Clubs in my university')"></head>
<body data-rows="3">
<header th:replace="fragments/common :: nav"></header>

<main class="container">
    <h2 class="m-0">Clubs in your university</h2>

    <!-- Sort only (you can add more filters later if needed) -->
    <form class="h-stack mt-1" th:action="@{/student/university/clubs}" method="get">
        <select name="sort">
            <option value="name" th:selected="${sort == 'name'}">Sort: Name</option>
            <option value="followers" th:selected="${sort == 'followers'}">Sort: Followers</option>
            <option value="members" th:selected="${sort == 'members'}">Sort: Members</option>
            <option value="recent" th:selected="${sort == 'recent'}">Sort: Most recent post</option>
        </select>
        <input type="hidden" name="page" value="0"/>
        <button class="btn" type="submit">Apply</button>
    </form>

    <div class="grid mt-2" th:if="${!clubs.empty}">
        <div class="club-card card"
             th:each="c,iter : ${clubs.content}"
             th:with="g=${(iter.index % 6) + 1}"
             th:attr="data-href=@{/clubs/{id}(id=${c.id})}"
             style="cursor: pointer;"
             onclick="window.location.href = this.getAttribute('data-href')">
            <div class="ccover" th:classappend="' g' + ${g}">
                <div class="ccover-sheen"></div>
            </div>

            <div class="ccard-avatar">
                <span class="ccard-avatar__text"
                      th:text="${#strings.substring(#strings.trim(c.name),0,2)}">CL</span>
            </div>

            <div class="ccard-body">
                <div class="ccard-header">
                    <div class="ccard-title" th:text="${c.name}">Club Name</div>
                    <span class="badge success" th:if="${memberClubIds.contains(c.id)}">Member</span>
                    <span class="badge warn" th:if="${applicationStatuses[c.id] != null}"
                          th:text="${applicationStatuses[c.id]}">PENDING</span>
                </div>

                <div class="meta" th:text="${c.universityName}">University</div>

                <div class="ccard-stats">
                    <div><strong th:text="${c.followerCount}">0</strong> <span class="muted">followers</span></div>
                    <div><strong th:text="${c.memberCount}">0</strong> <span class="muted">members</span></div>
                </div>

                <div class="ccard-actions">
                    <div class="left">
                        <form th:if="${cancelEligibleIds != null and cancelEligibleIds.contains(c.id)}"
                              th:action="@{/clubs/{id}/apply/cancel(id=${c.id})}" method="post" class="inline"
                              onclick="event.stopPropagation();">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn subtle" type="submit">Cancel</button>
                        </form>

                        <form th:if="${reapplyEligibleIds != null and reapplyEligibleIds.contains(c.id)}"
                              th:action="@{/clubs/{id}/apply/reapply(id=${c.id})}" method="post" class="inline"
                              onclick="event.stopPropagation();">
                            <input type="hidden" name="applicationText" value="Following up on my application."/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn" type="submit">Reapply</button>
                        </form>

                        <form th:if="${eligibleApplyIds.contains(c.id)}"
                              th:action="@{/clubs/{id}/apply(id=${c.id})}" method="post" class="inline"
                              onclick="event.stopPropagation();">
                            <input type="hidden" name="applicationText" value="I'd like to join this club."/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn" type="submit">Apply</button>
                        </form>
                    </div>

                    <div class="right">
                        <form th:action="@{/clubs/{id}/follow(id=${c.id})}" method="post" class="inline"
                              onclick="event.stopPropagation();">
                            <input type="hidden" name="back" th:value="${back}"/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn ghost" type="submit"
                                    th:text="${followedIds != null and followedIds.contains(c.id)} ? 'Following' : 'Follow'">Follow</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-2" th:if="${clubs.empty}">
        <p class="help">No clubs found.</p>
    </div>

    <div class="h-stack center mt-3" th:if="${clubs.totalPages > 1}">
        <a class="btn subtle" th:if="${!clubs.first}" th:href="@{/student/university/clubs(sort=${sort}, page=${page-1}, size=${size})}">Prev</a>
        <span>Page <strong th:text="${clubs.number + 1}"></strong> / <span th:text="${clubs.totalPages}"></span></span>
        <a class="btn subtle" th:if="${!clubs.last}" th:href="@{/student/university/clubs(sort=${sort}, page=${page+1}, size=${size})}">Next</a>
    </div>
</main>

<!-- Same card CSS as explore (kept page-scoped here) -->
<style>
    .club-card { --banner-h: 144px; --avatar: 88px; position: relative; padding: 0; overflow: hidden; }
    .club-card .ccover { position: relative; height: var(--banner-h); border-radius: 14px 14px 0 0; }
    .club-card .ccover.g1 { background: linear-gradient(135deg, #6366f1, #22d3ee); }
    .club-card .ccover.g2 { background: linear-gradient(135deg, #f59e0b, #ef4444); }
    .club-card .ccover.g3 { background: linear-gradient(135deg, #06b6d4, #10b981); }
    .club-card .ccover.g4 { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
    .club-card .ccover.g5 { background: linear-gradient(135deg, #3b82f6, #10b981); }
    .club-card .ccover.g6 { background: linear-gradient(135deg, #f43f5e, #f59e0b); }
    .club-card .ccover-sheen { position: absolute; inset: 0; background: radial-gradient(900px 240px at 70% 20%, rgba(255,255,255,.18), transparent 55%); pointer-events: none; }
    .club-card .ccover::after { content: ""; position: absolute; left: 16px; right: 16px; bottom: -1px; height: 2px; background: var(--border); }

    .ccard-avatar {
        position: absolute; left: 24px; top: calc(var(--banner-h) - (var(--avatar) / 2));
        width: var(--avatar); height: var(--avatar); border-radius: 999px;
        display: grid; place-items: center; border: 4px solid var(--card);
        background: linear-gradient(135deg, #111827, #374151); text-decoration: none; box-shadow: var(--shadow); z-index: 1;
    }
    .ccard-avatar__text { color: #fff; font-weight: 800; }

    .ccard-body { padding: 16px; padding-top: 22px; padding-left: calc(24px + var(--avatar) + 16px); display: flex; flex-direction: column; gap: 8px; }
    @media (max-width: 460px) { .ccard-body { padding-left: 16px; } }

    .ccard-header { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .ccard-title { font-weight: 800; font-size: 18px; color: var(--text); text-decoration: none; }
    .ccard-title:hover { text-decoration: underline; }

    .ccard-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 2px; }
    @media (max-width: 520px) { .ccard-stats { grid-template-columns: 1fr; } }

    .ccard-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .ccard-actions .left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .ccard-actions .right { margin-left: auto; }
    .ccard-actions .right .btn { border-radius: 999px; padding: 8px 14px; }

    .club-card:hover {
        background-color: var(--bg-soft);
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    /* Forms/buttons inside shouldn't trigger the parent onclick */
    .ccard-actions form, .ccard-actions button, .ccard-actions a { pointer-events: auto; }
</style>
</body>
</html>